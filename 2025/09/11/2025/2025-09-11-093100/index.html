<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Dylan,2894220@qq.com"><title>使用 Conan v1.x 交叉编译常见开源项目鸿蒙产物 · Dylan's blog</title><meta name="description" content="本文主要描述如何通过 conan 1.x 交叉编译常见的三方库到鸿蒙平台，基础的环境配置及工程化集成配置，以及在编译过程中遇到过的问题。


在现有业务中，我们已经有了一些成熟的跨平台项目在运行，支持 Android、iOS、Windows、macOS、Linux like 系统，这些项目各自都依赖"><meta name="keywords" content="Hexo,HTML,CSS,android,Linux"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><meta name="generator" content="Hexo 7.3.0"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">Dylan's blog</a></h3><div class="description"><p>To the pursuit of truth.</p></div></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="http://github.com/nmgwddj"><i class="fa fa-github"></i></a></li></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a target="_blank" rel="noopener" href="https://www.caicai.me"> CaiCai </a><span>&</span><a target="_blank" rel="noopener" href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/archives">归档</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img src="/images/favicon.png"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>使用 Conan v1.x 交叉编译常见开源项目鸿蒙产物</a></h3></div><div class="post-content"><p>本文主要描述如何通过 conan 1.x 交叉编译常见的三方库到鸿蒙平台，基础的环境配置及工程化集成配置，以及在编译过程中遇到过的问题。</p>
<span id="more"></span>

<p>在现有业务中，我们已经有了一些成熟的跨平台项目在运行，支持 Android、iOS、Windows、macOS、Linux like 系统，这些项目各自都依赖了大量的三方开源代码，如常见的 C 库 zlib、openssl、libcurl、libuv、sqlite3，C++ 库 jsoncpp、gtest 等。我们不可能为每个系统去单独维护编译脚本或产物，因为这个过程真的相当痛苦，你不仅需要了解不同的工程管理工具如 gn、cmake、autotools、makefile 等，还需要了解各个三方库的各类编译配置，做跨平台开发的同学一定能深有体会。</p>
<p>幸运的是我们已经在现有平台下通过 conan 全自动管理三方库产物，不需要刻意关心三方库的编译细节，只需要通过 conan 指定一个版本号让其自动帮我们编译即可。本文也将围绕这个话题，描述如何通过 conan 交叉编译常见的三方库到鸿蒙平台。通过本文你可以了解到：</p>
<ul>
<li>如何快速编译一个鸿蒙的三方库（静态或动态）</li>
<li>如何配置驱动现有使用 conan 1.x 的项目支持鸿蒙系统</li>
<li>有哪些已经踩过的坑</li>
<li>写好的 Dockerfile 可直接创建一个带有 conan 的鸿蒙交叉编译环境用于 CI 集成</li>
</ul>
<p>其中的优势在于：</p>
<ul>
<li>除特别需要不需要修改 conan 或三方库代码</li>
<li>使用系统已有的环境如 cmake、conan 等，无需使用工具链中定制的程序</li>
</ul>
<blockquote>
<p>因为历史债务问题，我们虽然已经切换了部分项目到 conan 2.x，但还有一部分项目依然在使用 conan 1.x，的确是因为切换成本较高且有些项目上的定制功能尚未在 conan 2.x 中找到好的解决方案，所以通过 conan 1.x 交叉编译到鸿蒙也是目前我们必须要考虑的重点。</p>
</blockquote>
<h2 id="步骤演示"><a href="#步骤演示" class="headerlink" title="步骤演示"></a>步骤演示</h2><p>官方提供了多个平台的交叉编译工具链，我们这里以 Linux 平台交叉编译到鸿蒙举例，因为后续 CI 自动化集成使用 Linux 更方便我们做自动化部署。</p>
<h3 id="配置交叉编译环境"><a href="#配置交叉编译环境" class="headerlink" title="配置交叉编译环境"></a>配置交叉编译环境</h3><p>首先登录华为开发者中心，下载完整的工具链压缩包：<a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/cn/download/command-line-tools-for-hmos">https://developer.huawei.com/consumer/cn/download/command-line-tools-for-hmos</a>，下载时选 for HarmonyOS 的版本。</p>
<div align="center">
<img src="/images/2025/09/2025-09-10_13-00-56.png" width=80% />
</div>

<p>由于这个压缩包过于庞大，一些与交叉编译工具链无关的工具，我们在解压时可以过滤掉，真正需要的只有 <code>command-line-tools/sdk/default/openharmony/native</code> 目录下的文件：</p>
<div align="center">
<img src="/images/2025/09/2025-09-10_13-06-10.png" width=80% />
</div>

<p>使用 unzip 解压可以控制只解压该目录下的文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unzip commandline-tools-linux-x64-5.0.13.230.zip <span class="string">&quot;command-line-tools/sdk/default/openharmony/native/*&quot;</span></span><br></pre></td></tr></table></figure>

<p>接下来我们要配置环境变量，让项目工程可以识别使用鸿蒙的工具链进行初始化工程及编译，假设你的工具链目录解压到了 ~&#x2F;Downloads&#x2F;command-line-tools 目录下：</p>
<p>设置当前终端环境变量（不污染整个系统）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> CC=~/Downloads/command-line-tools/sdk/default/openharmony/native/llvm/bin/clang</span><br><span class="line"><span class="built_in">export</span> CXX=~/Downloads/command-line-tools/sdk/default/openharmony/native/llvm/bin/clang++</span><br><span class="line"><span class="built_in">export</span> CMAKE_C_COMPILER=~/Downloads/command-line-tools/sdk/default/openharmony/native/llvm/bin/clang</span><br><span class="line"><span class="built_in">export</span> CMAKE_CXX_COMPILER=~/Downloads/command-line-tools/sdk/default/openharmony/native/llvm/bin/clang++</span><br><span class="line"><span class="built_in">export</span> STRIP=~/Downloads/command-line-tools/sdk/default/openharmony/native/llvm/bin/llvm-strip</span><br><span class="line"><span class="built_in">export</span> RANLIB=~/Downloads/command-line-tools/sdk/default/openharmony/native/llvm/bin/llvm-ranlib</span><br><span class="line"><span class="built_in">export</span> AS=~/Downloads/command-line-tools/sdk/default/openharmony/native/llvm/bin/llvm-ar</span><br><span class="line"><span class="built_in">export</span> AS=~/Downloads/command-line-tools/sdk/default/openharmony/native/llvm/bin/llvm-as</span><br><span class="line"><span class="built_in">export</span> AR=~/Downloads/command-line-tools/sdk/default/openharmony/native/llvm/bin/llvm-ar</span><br><span class="line"><span class="built_in">export</span> LD=~/Downloads/command-line-tools/sdk/default/openharmony/native/llvm/bin/ld.lld</span><br></pre></td></tr></table></figure>

<p>此时如果你在当前终端编译一个没有三方库依赖的代码，就已经可以使用鸿蒙的工具链了，我使用了一个简单的 CMake 项目做了测试：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ cmake -Bbuild -DCMAKE_C_FLAGS=<span class="string">&quot;--target=aarch64-linux-ohos -D__MUSL__=1&quot;</span> -DCMAKE_CXX_FLAGS=<span class="string">&quot;--target=aarch64-linux-ohos -D__MUSL__=1&quot;</span></span><br><span class="line">-- The C compiler identification is Clang 15.0.4</span><br><span class="line">-- The CXX compiler identification is Clang 15.0.4</span><br><span class="line">-- Detecting C compiler ABI info</span><br><span class="line">-- Detecting C compiler ABI info - <span class="keyword">done</span></span><br><span class="line">-- Check <span class="keyword">for</span> working C compiler: /home/yunxin/Downloads/command-line-tools/sdk/default/openharmony/native/llvm/bin/clang - skipped</span><br><span class="line">-- Detecting C compile features</span><br><span class="line">-- Detecting C compile features - <span class="keyword">done</span></span><br><span class="line">-- Detecting CXX compiler ABI info</span><br><span class="line">-- Detecting CXX compiler ABI info - <span class="keyword">done</span></span><br><span class="line">-- Check <span class="keyword">for</span> working CXX compiler: /home/yunxin/Downloads/command-line-tools/sdk/default/openharmony/native/llvm/bin/clang++ - skipped</span><br><span class="line">-- Detecting CXX compile features</span><br><span class="line">-- Detecting CXX compile features - <span class="keyword">done</span></span><br><span class="line">-- Configuring <span class="keyword">done</span></span><br><span class="line">-- Generating <span class="keyword">done</span></span><br><span class="line">-- Build files have been written to: /home/yunxin/Downloads/openharmony-library/build</span><br></pre></td></tr></table></figure>

<p>可以看到，C compiler 和 CXX compiler 都已经使用我们之前设置的鸿蒙的工具链了，其中 CMAKE_C_FLAGS 和 CMAKE_CXX_FLAGS 携带的两个参数分别表示：</p>
<ul>
<li><code>--target=aarch64-linux-ohos</code> 明确使用 aarch64-linux-ohos 工具链</li>
<li><code>-D__MUSL__=1</code> 添加全局宏明确表示使用 musl libc 而不是 GNU libc，这是华为官网帮助文档中要求加入的</li>
</ul>
<p>执行 cmake 的编译指令后，即可编译出产物：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ cmake --build build --config Release</span><br><span class="line">[ 50%] Building CXX object CMakeFiles/openharmony-library.dir/main.cc.o</span><br><span class="line">[100%] Linking CXX shared library libopenharmony-library.so</span><br><span class="line">[100%] Built target openharmony-library</span><br></pre></td></tr></table></figure>

<p>使用 file 命令查看一下产物，也已经是 aarch64 架构了：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ file build/libopenharmony-library.so</span><br><span class="line">build/libopenharmony-library.so: ELF 64-bit LSB shared object, ARM aarch64, version 1 (SYSV), dynamically linked, with debug_info, not stripped</span><br></pre></td></tr></table></figure>

<p>如果没有以上两个参数，会无法正确初始化 CMake 工程报错，如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">$ cmake -Bbuild</span><br><span class="line">-- The C compiler identification is Clang 15.0.4</span><br><span class="line">-- The CXX compiler identification is Clang 15.0.4</span><br><span class="line">-- Detecting C compiler ABI info</span><br><span class="line">-- Detecting C compiler ABI info - <span class="keyword">done</span></span><br><span class="line">-- Check <span class="keyword">for</span> working C compiler: /home/yunxin/Downloads/command-line-tools/sdk/default/openharmony/native/llvm/bin/clang - skipped</span><br><span class="line">-- Detecting C compile features</span><br><span class="line">-- Detecting C compile features - <span class="keyword">done</span></span><br><span class="line">-- Detecting CXX compiler ABI info</span><br><span class="line">-- Detecting CXX compiler ABI info - failed</span><br><span class="line">-- Check <span class="keyword">for</span> working CXX compiler: /home/yunxin/Downloads/command-line-tools/sdk/default/openharmony/native/llvm/bin/clang++</span><br><span class="line">-- Check <span class="keyword">for</span> working CXX compiler: /home/yunxin/Downloads/command-line-tools/sdk/default/openharmony/native/llvm/bin/clang++ - broken</span><br><span class="line">CMake Error at /usr/share/cmake-3.22/Modules/CMakeTestCXXCompiler.cmake:62 (message):</span><br><span class="line">  The C++ compiler</span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;/home/yunxin/Downloads/command-line-tools/sdk/default/openharmony/native/llvm/bin/clang++&quot;</span></span><br><span class="line"></span><br><span class="line">  is not able to compile a simple <span class="built_in">test</span> program.</span><br><span class="line"></span><br><span class="line">  It fails with the following output:</span><br><span class="line"></span><br><span class="line">    Change Dir: /home/yunxin/Downloads/openharmony-library/build/CMakeFiles/CMakeTmp</span><br><span class="line"></span><br><span class="line">    Run Build Command(s):/usr/bin/gmake -f Makefile cmTC_55ffc/fast &amp;&amp; /usr/bin/gmake  -f CMakeFiles/cmTC_55ffc.<span class="built_in">dir</span>/build.make CMakeFiles/cmTC_55ffc.<span class="built_in">dir</span>/build</span><br><span class="line">    gmake[1]: Entering directory <span class="string">&#x27;/home/yunxin/Downloads/openharmony-library/build/CMakeFiles/CMakeTmp&#x27;</span></span><br><span class="line">    Building CXX object CMakeFiles/cmTC_55ffc.<span class="built_in">dir</span>/testCXXCompiler.cxx.o</span><br><span class="line">    /home/yunxin/Downloads/command-line-tools/sdk/default/openharmony/native/llvm/bin/clang++    -MD -MT CMakeFiles/cmTC_55ffc.<span class="built_in">dir</span>/testCXXCompiler.cxx.o -MF CMakeFiles/cmTC_55ffc.<span class="built_in">dir</span>/testCXXCompiler.cxx.o.d -o CMakeFiles/cmTC_55ffc.<span class="built_in">dir</span>/testCXXCompiler.cxx.o -c /home/yunxin/Downloads/openharmony-library/build/CMakeFiles/CMakeTmp/testCXXCompiler.cxx</span><br><span class="line">    Linking CXX executable cmTC_55ffc</span><br><span class="line">    /usr/bin/cmake -E cmake_link_script CMakeFiles/cmTC_55ffc.<span class="built_in">dir</span>/link.txt --verbose=1</span><br><span class="line">    /home/yunxin/Downloads/command-line-tools/sdk/default/openharmony/native/llvm/bin/clang++ CMakeFiles/cmTC_55ffc.<span class="built_in">dir</span>/testCXXCompiler.cxx.o -o cmTC_55ffc</span><br><span class="line">    /usr/bin/ld: cannot find -lstdc++: No such file or directory</span><br><span class="line">    clang-15: error: linker <span class="built_in">command</span> failed with <span class="built_in">exit</span> code 1 (use -v to see invocation)</span><br><span class="line">    gmake[1]: *** [CMakeFiles/cmTC_55ffc.<span class="built_in">dir</span>/build.make:100: cmTC_55ffc] Error 1</span><br><span class="line">    gmake[1]: Leaving directory <span class="string">&#x27;/home/yunxin/Downloads/openharmony-library/build/CMakeFiles/CMakeTmp&#x27;</span></span><br><span class="line">    gmake: *** [Makefile:127: cmTC_55ffc/fast] Error 2</span><br><span class="line"></span><br><span class="line">  CMake will not be able to correctly generate this project.</span><br><span class="line">Call Stack (most recent call first):</span><br><span class="line">  CMakeLists.txt:3 (project)</span><br></pre></td></tr></table></figure>

<h3 id="添加鸿蒙平台的-conan-profile"><a href="#添加鸿蒙平台的-conan-profile" class="headerlink" title="添加鸿蒙平台的 conan profile"></a>添加鸿蒙平台的 conan profile</h3><p>如果想让 conan 也使用这套配置，我们还需要新增一个针对鸿蒙工具链的 profile 配置文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[settings]</span><br><span class="line">os=Linux</span><br><span class="line"><span class="built_in">arch</span>=armv8</span><br><span class="line">compiler=clang</span><br><span class="line">compiler.version=15</span><br><span class="line">compiler.libcxx=c++_static</span><br><span class="line">compiler.cppstd=11</span><br><span class="line">[options]</span><br><span class="line">[build_requires]</span><br><span class="line">[conf]</span><br><span class="line">[<span class="built_in">env</span>]</span><br><span class="line">CC=/home/yunxin/Downloads/command-line-tools/sdk/default/openharmony/native/llvm/bin/clang</span><br><span class="line">CXX=/home/yunxin/Downloads/command-line-tools/sdk/default/openharmony/native/llvm/bin/clang++</span><br><span class="line">CMAKE_C_COMPILER=/home/yunxin/Downloads/command-line-tools/sdk/default/openharmony/native/llvm/bin/clang</span><br><span class="line">CMAKE_CXX_COMPILER=/home/yunxin/Downloads/command-line-tools/sdk/default/openharmony/native/llvm/bin/clang++</span><br><span class="line">STRIP=/home/yunxin/Downloads/command-line-tools/sdk/default/openharmony/native/llvm/bin/llvm-strip</span><br><span class="line">RANLIB=/home/yunxin/Downloads/command-line-tools/sdk/default/openharmony/native/llvm/bin/llvm-ranlib</span><br><span class="line">AS=/home/yunxin/Downloads/command-line-tools/sdk/default/openharmony/native/llvm/bin/llvm-as</span><br><span class="line">AR=/home/yunxin/Downloads/command-line-tools/sdk/default/openharmony/native/llvm/bin/llvm-ar</span><br><span class="line">LD=/home/yunxin/Downloads/command-line-tools/sdk/default/openharmony/native/llvm/bin/ld.lld</span><br><span class="line">CFLAGS=<span class="string">&quot;--target=aarch64-linux-ohos -D__MUSL__=1&quot;</span></span><br><span class="line">CXXFLAGS=<span class="string">&quot;--target=aarch64-linux-ohos -D__MUSL__=1&quot;</span></span><br></pre></td></tr></table></figure>

<p>参数解释：</p>
<ul>
<li><code>os=Linux</code> 表示让产物还是以 Linux like 方式编译，因为鸿蒙的交叉编译工具链还是基于 Linux like 改进</li>
<li><code>arch=armv8</code> 编译为 armv8 架构的，这个参数还是要给，虽然重要性不大，因为我们在工具链中设置了 —target 参数</li>
<li><code>compiler=clang</code> 表示使用 clang，conan 会做校验</li>
<li><code>compiler.version=15</code> 表示使用 clang 15 版本，版本号是我从鸿蒙工具链中获取的，如果这里给的不对 conan 会给警告</li>
<li><code>compiler.libcxx=c++_static</code> 表示静态链接 C++ 标准库，这个类似 NDK，给 c++_shared 表示动态链接系统库</li>
<li><code>compiler.cppstd=11</code> 表示如果被编译目标是 C++ 代码，则以 C++ 11 作为标准编译</li>
<li><code>[env]</code> 中所有参数就是工具链的目录，其中比较重要的是 CFLAGS 和 CXXFLAGS 明确使用哪种架构和添加全局宏</li>
</ul>
<p>将以上内容保存为名为 <code>openharmony-arm64-v8a-clang15</code> 的文件，然后尝试使用 conan 编译一个三方库 openssl 1.1.1w 的版本，执行命令后输出如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line">$ conan install openssl/1.1.1w@ -<span class="built_in">pr</span>:b=default -<span class="built_in">pr</span>:h=./openharmony-arm64-v8a-clang15 --build missing</span><br><span class="line"></span><br><span class="line">WARN: **************************************************</span><br><span class="line">WARN: *** Conan 1 is legacy and on a deprecation path **</span><br><span class="line">WARN: *********** Please upgrade to Conan 2 ************</span><br><span class="line">WARN: **************************************************</span><br><span class="line">Configuration (profile_host):</span><br><span class="line">[settings]</span><br><span class="line"><span class="built_in">arch</span>=armv8</span><br><span class="line">compiler=clang</span><br><span class="line">compiler.cppstd=11</span><br><span class="line">compiler.libcxx=c++_static</span><br><span class="line">compiler.version=15</span><br><span class="line">os=Linux</span><br><span class="line">[options]</span><br><span class="line">[build_requires]</span><br><span class="line">[<span class="built_in">env</span>]</span><br><span class="line">AR=/home/yunxin/Downloads/command-line-tools/sdk/default/openharmony/native/llvm/bin/llvm-ar</span><br><span class="line">AS=/home/yunxin/Downloads/command-line-tools/sdk/default/openharmony/native/llvm/bin/llvm-as</span><br><span class="line">CC=/home/yunxin/Downloads/command-line-tools/sdk/default/openharmony/native/llvm/bin/clang</span><br><span class="line">CFLAGS=--target=aarch64-linux-ohos -D__MUSL__=1</span><br><span class="line">CMAKE_CXX_COMPILER=/home/yunxin/Downloads/command-line-tools/sdk/default/openharmony/native/llvm/bin/clang++</span><br><span class="line">CMAKE_C_COMPILER=/home/yunxin/Downloads/command-line-tools/sdk/default/openharmony/native/llvm/bin/clang</span><br><span class="line">CXX=/home/yunxin/Downloads/command-line-tools/sdk/default/openharmony/native/llvm/bin/clang++</span><br><span class="line">CXXFLAGS=--target=aarch64-linux-ohos -D__MUSL__=1</span><br><span class="line">LD=/home/yunxin/Downloads/command-line-tools/sdk/default/openharmony/native/llvm/bin/ld.lld</span><br><span class="line">RANLIB=/home/yunxin/Downloads/command-line-tools/sdk/default/openharmony/native/llvm/bin/llvm-ranlib</span><br><span class="line">STRIP=/home/yunxin/Downloads/command-line-tools/sdk/default/openharmony/native/llvm/bin/llvm-strip</span><br><span class="line">Configuration (profile_build):</span><br><span class="line">[settings]</span><br><span class="line"><span class="built_in">arch</span>=x86_64</span><br><span class="line">arch_build=x86_64</span><br><span class="line">build_type=Release</span><br><span class="line">compiler=gcc</span><br><span class="line">compiler.cppstd=17</span><br><span class="line">compiler.libcxx=libstdc++11</span><br><span class="line">compiler.version=11</span><br><span class="line">os=Linux</span><br><span class="line">os_build=Linux</span><br><span class="line">[options]</span><br><span class="line">[build_requires]</span><br><span class="line">[<span class="built_in">env</span>]</span><br><span class="line">openssl/1.1.1w: Not found <span class="keyword">in</span> <span class="built_in">local</span> cache, looking <span class="keyword">in</span> remotes...</span><br><span class="line">openssl/1.1.1w: Trying with <span class="string">&#x27;conancenter&#x27;</span>...</span><br><span class="line">Downloading conanmanifest.txt completed [0.18k]</span><br><span class="line">Downloading conanfile.py completed [27.92k]</span><br><span class="line">Downloading conan_export.tgz completed [0.42k]</span><br><span class="line">Decompressing conan_export.tgz completed [0.00k]</span><br><span class="line">openssl/1.1.1w: Downloaded recipe revision a8f0792d7c5121b954578a7149d23e03</span><br><span class="line">Installing package: openssl/1.1.1w</span><br><span class="line">Requirements</span><br><span class="line">    openssl/1.1.1w from <span class="string">&#x27;conancenter&#x27;</span> - Downloaded</span><br><span class="line">Packages</span><br><span class="line">    openssl/1.1.1w:5cd37d28260aadc1d02b4d029448db7bbf9e1e04 - Build</span><br><span class="line"></span><br><span class="line">Cross-build from <span class="string">&#x27;Linux:x86_64&#x27;</span> to <span class="string">&#x27;Linux:armv8&#x27;</span></span><br><span class="line">Installing (downloading, building) binaries...</span><br><span class="line">Downloading conan_sources.tgz completed [0.49k]</span><br><span class="line">Decompressing conan_sources.tgz completed [0.00k]</span><br><span class="line">openssl/1.1.1w: Configuring sources <span class="keyword">in</span> /home/yunxin/.conan/data/openssl/1.1.1w/_/_/source/src</span><br><span class="line">Downloading openssl-1.1.1w.tar.gz completed [9661.51k]                                   openssl/1.1.1w: enssl/1.1.1w:</span><br><span class="line">openssl/1.1.1w:</span><br><span class="line">openssl/1.1.1w: Copying sources to build folder</span><br><span class="line">openssl/1.1.1w: Building your package <span class="keyword">in</span> /home/yunxin/.conan/data/openssl/1.1.1w/_/_/build/5cd37d28260aadc1d02b4d029448db7bbf9e1e04</span><br><span class="line">openssl/1.1.1w: Generator txt created conanbuildinfo.txt</span><br><span class="line">openssl/1.1.1w: Calling generate()</span><br><span class="line">openssl/1.1.1w: Aggregating <span class="built_in">env</span> generators</span><br><span class="line">openssl/1.1.1w: Calling build()</span><br><span class="line">openssl/1.1.1w: Apply patch (portability): TVOS and WatchOS don<span class="string">&#x27;t like fork()</span></span><br><span class="line"><span class="string">openssl/1.1.1w: gen_info = &#123;&#x27;</span>CFLAGS<span class="string">&#x27;: [&#x27;</span>-fPIC<span class="string">&#x27;], &#x27;</span>CXXFLAGS<span class="string">&#x27;: [&#x27;</span>-fPIC<span class="string">&#x27;], &#x27;</span>DEFINES<span class="string">&#x27;: [], &#x27;</span>LDFLAGS<span class="string">&#x27;: []&#125;</span></span><br><span class="line"><span class="string">openssl/1.1.1w: using target: conan-None-Linux-armv8-clang-15 -&gt; linux-aarch64</span></span><br><span class="line"><span class="string">openssl/1.1.1w: my %targets = (</span></span><br><span class="line"><span class="string">    &quot;conan-None-Linux-armv8-clang-15&quot; =&gt; &#123;</span></span><br><span class="line"><span class="string">        inherit_from =&gt; [ &quot;linux-aarch64&quot; ],</span></span><br><span class="line"><span class="string">        cflags =&gt; add(&quot;-fPIC&quot;),</span></span><br><span class="line"><span class="string">        cxxflags =&gt; add(&quot;-fPIC&quot;),</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        includes =&gt; add(),</span></span><br><span class="line"><span class="string">        lflags =&gt; add(&quot;&quot;),</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        cc =&gt; &quot;/home/yunxin/Downloads/command-line-tools/sdk/default/openharmony/native/llvm/bin/clang&quot;,</span></span><br><span class="line"><span class="string">        cxx =&gt; &quot;/home/yunxin/Downloads/command-line-tools/sdk/default/openharmony/native/llvm/bin/clang++&quot;,</span></span><br><span class="line"><span class="string">        ar =&gt; &quot;/home/yunxin/Downloads/command-line-tools/sdk/default/openharmony/native/llvm/bin/llvm-ar&quot;,</span></span><br><span class="line"><span class="string">        ranlib =&gt; &quot;/home/yunxin/Downloads/command-line-tools/sdk/default/openharmony/native/llvm/bin/llvm-ranlib&quot;,</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">openssl/1.1.1w: [&#x27;</span><span class="string">&quot;conan-None-Linux-armv8-clang-15&quot;</span><span class="string">&#x27;, &#x27;</span>no-shared<span class="string">&#x27;, &#x27;</span>--prefix=/<span class="string">&#x27;, &#x27;</span>--openssldir=<span class="string">&quot;/etc/ssl&quot;</span><span class="string">&#x27;, &#x27;</span>no-unit-test<span class="string">&#x27;, &#x27;</span>threads<span class="string">&#x27;, &#x27;</span>PERL=perl<span class="string">&#x27;, &#x27;</span>no-tests<span class="string">&#x27;, &#x27;</span>--release<span class="string">&#x27;, &#x27;</span>--libdir=lib<span class="string">&#x27;, &#x27;</span>-fPIC<span class="string">&#x27;, &#x27;</span>no-md2<span class="string">&#x27;]</span></span><br><span class="line"><span class="string">Configuring OpenSSL version 1.1.1w (0x1010117fL) for conan-None-Linux-armv8-clang-15</span></span><br><span class="line"><span class="string">Using os-specific seed configuration</span></span><br><span class="line"><span class="string">Creating configdata.pm</span></span><br><span class="line"><span class="string">Creating Makefile</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">**********************************************************************</span></span><br><span class="line"><span class="string">***                                                                ***</span></span><br><span class="line"><span class="string">***   OpenSSL has been successfully configured                     ***</span></span><br><span class="line"><span class="string">***                                                                ***</span></span><br><span class="line"><span class="string">***   If you encounter a problem while building, please open an    ***</span></span><br><span class="line"><span class="string">***   issue on GitHub &lt;https://github.com/openssl/openssl/issues&gt;  ***</span></span><br><span class="line"><span class="string">***   and include the output from the following command:           ***</span></span><br><span class="line"><span class="string">***                                                                ***</span></span><br><span class="line"><span class="string">***       perl configdata.pm --dump                                ***</span></span><br><span class="line"><span class="string">***                                                                ***</span></span><br><span class="line"><span class="string">***   (If you are new to OpenSSL, you might want to consult the    ***</span></span><br><span class="line"><span class="string">***   &#x27;</span>Troubleshooting<span class="string">&#x27; section in the INSTALL file first)         ***</span></span><br><span class="line"><span class="string">***                                                                ***</span></span><br><span class="line"><span class="string">**********************************************************************</span></span><br><span class="line"><span class="string">perl &quot;-I.&quot; -Mconfigdata &quot;util/dofile.pl&quot; \</span></span><br><span class="line"><span class="string">    &quot;-oMakefile&quot; include/crypto/bn_conf.h.in &gt; include/crypto/bn_conf.h</span></span><br><span class="line"><span class="string">perl &quot;-I.&quot; -Mconfigdata &quot;util/dofile.pl&quot; \</span></span><br><span class="line"><span class="string">    &quot;-oMakefile&quot; include/crypto/dso_conf.h.in &gt; include/crypto/dso_conf.h</span></span><br><span class="line"><span class="string">perl &quot;-I.&quot; -Mconfigdata &quot;util/dofile.pl&quot; \</span></span><br><span class="line"><span class="string">    &quot;-oMakefile&quot; include/openssl/opensslconf.h.in &gt; include/openssl/opensslconf.h</span></span><br><span class="line"><span class="string">make depend &amp;&amp; make _all</span></span><br><span class="line"><span class="string">make[1]: Entering directory &#x27;</span>/home/yunxin/.conan/data/openssl/1.1.1w/_/_/build/5cd37d28260aadc1d02b4d029448db7bbf9e1e04/src<span class="string">&#x27;</span></span><br><span class="line"><span class="string">make[1]: Leaving directory &#x27;</span>/home/yunxin/.conan/data/openssl/1.1.1w/_/_/build/5cd37d28260aadc1d02b4d029448db7bbf9e1e04/src<span class="string">&#x27;</span></span><br><span class="line"><span class="string">make[1]: Entering directory &#x27;</span>/home/yunxin/.conan/data/openssl/1.1.1w/_/_/build/5cd37d28260aadc1d02b4d029448db7bbf9e1e04/src<span class="string">&#x27;</span></span><br><span class="line"><span class="string">/home/yunxin/Downloads/command-line-tools/sdk/default/openharmony/native/llvm/bin/clang  -I. -Iinclude -fPIC -pthread -fPIC -Wa,--noexecstack -Qunused-arguments --target=aarch64-linux-ohos -D__MUSL__=1 -fPIC -fPIC -DOPENSSL_USE_NODELETE -DOPENSSL_PIC -DOPENSSL_CPUID_OBJ -DOPENSSL_BN_ASM_MONT -DSHA1_ASM -DSHA256_ASM -DSHA512_ASM -DKECCAK1600_ASM -DVPAES_ASM -DECP_NISTZ256_ASM -DPOLY1305_ASM -DOPENSSLDIR=&quot;\&quot;/etc/ssl\&quot;&quot; -DENGINESDIR=&quot;\&quot;//lib/engines-1.1\&quot;&quot; -DNDEBUG  -MMD -MF apps/app_rand.d.tmp -MT apps/app_rand.o -c -o apps/app_rand.o apps/app_rand.c</span></span><br><span class="line"><span class="string">……… 省略</span></span><br></pre></td></tr></table></figure>

<p>可以看到编译 openssl 已经能正确识别到我们通过 conan profile 设置的工具链，命令相关参数解释：</p>
<ul>
<li><code>-pr:b=default</code> 如果在交叉编译中需要运行一下本地程序来对代码进行更改如应用 patch 等，需要使用本地环境而不是编译的目标环境，系统默认是 gcc</li>
<li><code>-pr:h=./openharmony-arm64-v8a-clang15</code> 表示编译的目标环境使用这个配置</li>
<li><code>--build missing</code> 表示本地如果没有或有依赖不存则，则直接重新编译</li>
</ul>
<p>说白了这几个参数就是告诉 conan 需要从本地的 x86_64 环境交叉编译到鸿蒙的 arm64-v8a，同时给出了本地环境的工具链和目标环境的工具链路径、参数配置等信息。如果想进一步验证配置有效性，我建议使用 libcurl 进行测试，因为 libcurl 在编译目标产物时还需要在本地执行 m4、automake 等工具来生成一些编译配置，而且完整的 libcurl 编译也会自动依赖 openssl、zlib 等三方库。如果 libcurl 也可以通过，那么你的环境配置就没什么问题了，命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">conan install libcurl/8.6.0@ -<span class="built_in">pr</span>:b=default -<span class="built_in">pr</span>:h=./openharmony-arm64-v8a-clang15 -s build_type=Release --build missing</span><br></pre></td></tr></table></figure>
<blockquote>
<p>多了个 -s build_type&#x3D;Release 参数主要是一些三方库要明确指定编译的类型，如 zlib</p>
</blockquote>
<h2 id="工程化集成"><a href="#工程化集成" class="headerlink" title="工程化集成"></a>工程化集成</h2><p>为了方便 CI 集成，我们将以上步骤封装为一个携带了 conan + 鸿蒙工具链的 Dockerfile，如果你需要快速创建一个鸿蒙的交叉编译环境，可以考虑使用：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> conanio/gcc9-ubuntu18.<span class="number">04</span>:latest</span><br><span class="line"></span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> maintainer=<span class="string">&quot;Dylan &lt;2894220@gmail.com&gt;&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set global arguments</span></span><br><span class="line"><span class="keyword">ARG</span> CONAN_VERSION=<span class="number">1.66</span>.<span class="number">0</span></span><br><span class="line"><span class="keyword">ARG</span> REINSTALL_CMAKE_VERSION_FROM_SOURCE=<span class="number">3.31</span>.<span class="number">6</span></span><br><span class="line"><span class="keyword">ARG</span> TOOLCHAIN_URL</span><br><span class="line"><span class="keyword">ARG</span> TOOLCHAIN_PREFIX=command-line-tools/sdk/default/openharmony/native/llvm/bin</span><br><span class="line"></span><br><span class="line"><span class="comment"># Copy custom sources.list to use faster mirrors</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> sources.list /etc/apt/sources.list</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> sudo apt-get update</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> sudo apt-get install -q -y zip vim</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Reinstall conan and cmake to specific versions</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> sudo pip3 uninstall conan -y</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> sudo pip3 install conan==<span class="variable">$&#123;CONAN_VERSION&#125;</span></span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> conan profile new default --detect --force</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> sudo pip3 uninstall cmake &amp;&amp; pip3 install cmake==3.31.6</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> sudo <span class="built_in">ln</span> -sf /opt/pyenv/shims/cmake /usr/bin</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Download and unpack the toolchain</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> sudo curl -L -s <span class="variable">$&#123;TOOLCHAIN_URL&#125;</span> -o command-line-tools.zip</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> unzip command-line-tools.zip <span class="string">&quot;command-line-tools/sdk/default/openharmony/native/*&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Write toolchain paths to /etc/environment for system-wide access</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> sudo <span class="built_in">chmod</span> 777 /etc/environment</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> sudo <span class="built_in">echo</span> &gt;&gt; /etc/environment</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> sudo <span class="built_in">echo</span> CC=<span class="variable">$&#123;CONAN_USER_HOME&#125;</span>/<span class="variable">$&#123;TOOLCHAIN_PREFIX&#125;</span>/clang &gt;&gt; /etc/environment</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> sudo <span class="built_in">echo</span> CXX=<span class="variable">$&#123;CONAN_USER_HOME&#125;</span>/<span class="variable">$&#123;TOOLCHAIN_PREFIX&#125;</span>/clang++ &gt;&gt; /etc/environment</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> sudo <span class="built_in">echo</span> CMAKE_C_COMPILER=<span class="variable">$&#123;CONAN_USER_HOME&#125;</span>/<span class="variable">$&#123;TOOLCHAIN_PREFIX&#125;</span>/clang &gt;&gt; /etc/environment</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> sudo <span class="built_in">echo</span> CMAKE_CXX_COMPILER=<span class="variable">$&#123;CONAN_USER_HOME&#125;</span>/<span class="variable">$&#123;TOOLCHAIN_PREFIX&#125;</span>/clang++ &gt;&gt; /etc/environment</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> sudo <span class="built_in">echo</span> STRIP=<span class="variable">$&#123;CONAN_USER_HOME&#125;</span>/<span class="variable">$&#123;TOOLCHAIN_PREFIX&#125;</span>/llvm-strip &gt;&gt; /etc/environment</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> sudo <span class="built_in">echo</span> RANLIB=<span class="variable">$&#123;CONAN_USER_HOME&#125;</span>/<span class="variable">$&#123;TOOLCHAIN_PREFIX&#125;</span>/llvm-ranlib &gt;&gt; /etc/environment</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> sudo <span class="built_in">echo</span> AS=<span class="variable">$&#123;CONAN_USER_HOME&#125;</span>/<span class="variable">$&#123;TOOLCHAIN_PREFIX&#125;</span>/llvm-as &gt;&gt; /etc/environment</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> sudo <span class="built_in">echo</span> AR=<span class="variable">$&#123;CONAN_USER_HOME&#125;</span>/<span class="variable">$&#123;TOOLCHAIN_PREFIX&#125;</span>/llvm-ar &gt;&gt; /etc/environment</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> sudo <span class="built_in">echo</span> LD=<span class="variable">$&#123;CONAN_USER_HOME&#125;</span>/<span class="variable">$&#123;TOOLCHAIN_PREFIX&#125;</span>/ld.lld &gt;&gt; /etc/environment</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set environment variables for the current session</span></span><br><span class="line"><span class="keyword">ENV</span> CC=$&#123;CONAN_USER_HOME&#125;/$&#123;TOOLCHAIN_PREFIX&#125;/clang</span><br><span class="line"><span class="keyword">ENV</span> CXX=$&#123;CONAN_USER_HOME&#125;/$&#123;TOOLCHAIN_PREFIX&#125;/clang++</span><br><span class="line"><span class="keyword">ENV</span> CMAKE_C_COMPILER=$&#123;CONAN_USER_HOME&#125;/$&#123;TOOLCHAIN_PREFIX&#125;/clang</span><br><span class="line"><span class="keyword">ENV</span> CMAKE_CXX_COMPILER=$&#123;CONAN_USER_HOME&#125;/$&#123;TOOLCHAIN_PREFIX&#125;/clang++</span><br><span class="line"><span class="keyword">ENV</span> STRIP=$&#123;CONAN_USER_HOME&#125;/$&#123;TOOLCHAIN_PREFIX&#125;/llvm-strip</span><br><span class="line"><span class="keyword">ENV</span> RANLIB=$&#123;CONAN_USER_HOME&#125;/$&#123;TOOLCHAIN_PREFIX&#125;/llvm-ranlib</span><br><span class="line"><span class="keyword">ENV</span> AS=$&#123;CONAN_USER_HOME&#125;/$&#123;TOOLCHAIN_PREFIX&#125;/llvm-as</span><br><span class="line"><span class="keyword">ENV</span> AR=$&#123;CONAN_USER_HOME&#125;/$&#123;TOOLCHAIN_PREFIX&#125;/llvm-ar</span><br><span class="line"><span class="keyword">ENV</span> LD=$&#123;CONAN_USER_HOME&#125;/$&#123;TOOLCHAIN_PREFIX&#125;/ld.lld</span><br></pre></td></tr></table></figure>

<p>编译镜像需要至少指定一个 TOOLCHAIN_URL 的参数，该参数是鸿蒙交叉编译工具链的下载地址，因为华为官方的地址需要鉴权，所以我们下载后备份到了自己的服务器上，您也可以上传到自己的内网服务器上来测试用：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker build -t openharmony-toolchain . --build-arg \</span><br><span class="line">    TOOLCHAIN_URL=https://yourdomain.com/commandline-tools-linux-x64-5.0.13.230.zip</span><br></pre></td></tr></table></figure>

<p>编译完成后可以直接基于镜像运行容器：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker run -it \</span><br><span class="line">    --name openharmony-toolchain-1 \</span><br><span class="line">    --entrypoint /bin/bash openharmony-toolchain</span><br></pre></td></tr></table></figure>

<p>运行后就进入了包含 conan 和鸿蒙交叉编译工具链的环境了，您可以直接在该环境下编译鸿蒙的项目，您可以在镜像中集成 jenkins agent 或 gitlab runner 作为一个 CI 环境直接使用。</p>
<h2 id="已知问题"><a href="#已知问题" class="headerlink" title="已知问题"></a>已知问题</h2><p>在编译业务代码时，我们碰到了一些小问题，如链接不到 <code>pthread_cancel</code> 函数，虽然编译能过，但是链接失败，这是因为 musl 没有导出该方法，推荐使用 <code>pthread_kill</code> 实现，在业务代码中，可通过宏 <code>__OHOS__</code> 来判断是否是使用鸿蒙工具链编译的产物，如：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span> defined(ANDROID) || defined(__OHOS__)</span></span><br><span class="line">    <span class="comment">/* pthread_cancel() will not be supported in Bionic,</span></span><br><span class="line"><span class="comment">     * because doing this would involve making the C library</span></span><br><span class="line"><span class="comment">     * significantly bigger for very little benefit.</span></span><br><span class="line"><span class="comment">     * [...] All of this is contrary to the Bionic design goals.</span></span><br><span class="line"><span class="comment">     * If your code depends on thread cancellation, please consider alternatives.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> ((ret = pthread_kill(*((<span class="type">pthread_t</span>*)tid), SIGUSR1)) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Error cancelling thread %ld, error = %d (%s)&quot;</span>, *((<span class="type">pthread_t</span>*)tid), ret, strerror(ret));</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    pthread_cancel(*((<span class="type">pthread_t</span>*)tid));</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>另外因为业务代码有依赖 libuv，在使用 conan 依赖 libuv 时同样会出现链接 <code>pthread_setaffinity_np</code> 失败的情况，你可以切换到直接链接系统的 libuv 而不是使用 conan 依赖，鸿蒙工具链中携带了预编译好的 uv 库，还能进一步减少产物体积。</p>
<p>如果你就是不想用系统的 libuv，希望独立管理 libuv 代码，你需要关注一下 libuv <a target="_blank" rel="noopener" href="https://github.com/libuv/libuv/blob/v1.x/src/unix/thread.c#L217-L224">1.51.x 版本针对 OHOS 的适配</a>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span> defined(__ANDROID__) || defined(__OHOS__)</span></span><br><span class="line">  <span class="keyword">if</span> (sched_setaffinity(pthread_gettid_np(*tid), <span class="keyword">sizeof</span>(cpuset), &amp;cpuset))</span><br><span class="line">    r = errno;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    r = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">  r = pthread_setaffinity_np(*tid, <span class="keyword">sizeof</span>(cpuset), &amp;cpuset);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>更重要的是，libuv 官方代码即使你设置了 <code>-fvisibility=hidden</code> 选项，其代码还是会默认导出 API，这会与系统默认携带的 libuv 冲突，运行时挂掉，这是我碰到的崩溃栈：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Module name:com.netease.nimsample</span><br><span class="line">Version:2.0.0</span><br><span class="line">VersionCode:1</span><br><span class="line">PreInstalled:No</span><br><span class="line">Foreground:Yes</span><br><span class="line">Timestamp:2025-09-09 20:40:27.387</span><br><span class="line">Pid:48309</span><br><span class="line">Uid:20020197</span><br><span class="line">Process name:com.netease.nimsample</span><br><span class="line">Process life time:13s</span><br><span class="line">Reason:Signal:SIGSYS(UNKNOWN)</span><br><span class="line">Fault thread info:</span><br><span class="line">Tid:48556, Name:TuanjieMain</span><br><span class="line"><span class="comment">#00 pc 00000000000a4bdc /system/lib/ld-musl-aarch64.so.1(f77c0346c0084ebbadf721ea319f5f77)</span></span><br><span class="line"><span class="comment">#01 pc 0000000000283648 /data/storage/el1/bundle/libs/arm64/libnim.so(uv__iou_init+200)</span></span><br><span class="line"><span class="comment">#02 pc 0000000000283554 /data/storage/el1/bundle/libs/arm64/libnim.so(uv__platform_loop_init+76)</span></span><br><span class="line"><span class="comment">#03 pc 000000000027a9d8 /data/storage/el1/bundle/libs/arm64/libnim.so(uv_loop_init+292)</span></span><br><span class="line"><span class="comment">#04 pc 00000000001b67b8 /data/storage/el1/bundle/libs/arm64/libnim.so(http_run_uv_loop+244)</span></span><br><span class="line"><span class="comment">#05 pc 000000000015553c /data/storage/el1/bundle/libs/arm64/libnim.so(nim_component_init+1028)</span></span><br><span class="line"><span class="comment">#06 pc 000000000011d150 /data/storage/el1/bundle/libs/arm64/libnim.so(nim_client_init+20)</span></span><br></pre></td></tr></table></figure>

<p>你需要修改 libuv 的代码，根据配置决定是否导出符号，可以参考这个 PR（未合入官方代码）：<a target="_blank" rel="noopener" href="https://github.com/libuv/libuv/pull/4144">https://github.com/libuv/libuv/pull/4144</a></p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2025-09-11</span><i class="fa fa-tag"></i><a class="tag" href="/categories/language/" title="language">language </a><a class="tag" href="/categories/language/C-C/" title="C/C++">C/C++ </a><a class="tag" href="/categories/language/C-C/HarmonyOS/" title="HarmonyOS">HarmonyOS </a></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,https://nmgwddj.github.io/2025/09/11/2025/2025-09-11-093100/,Dylan's blog,使用 Conan v1.x 交叉编译常见开源项目鸿蒙产物,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="next pagbuttons"><a class="btn" role="navigation" href="/2025/05/20/2025/2025-05-20-194316/" title="SSL/TLS 安全传输 Root CA 管理之痛">下一篇</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>