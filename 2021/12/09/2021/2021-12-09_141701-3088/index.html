<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Dylan,2894220@qq.com"><title>CMake 自动安装 git pre-commit hooks · Dylan's blog</title><meta name="description" content="在日常开发中，我们经常通过各类 IDE 工具来自动修正代码风格，但由于部分 IDE 工具与 clang-format 配合不是特别完善，导致保存或者按下分号、冒号以后代码自动格式化导致错乱，或者格式化时间过长等问题。这在日常开发中是很难让人接受的。 那么我们有没有办法在开发过程中不去让 clang-"><meta name="keywords" content="Hexo,HTML,CSS,android,Linux"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><meta name="generator" content="Hexo 7.1.1"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">Dylan's blog</a></h3><div class="description"><p>To the pursuit of truth.</p></div></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="http://github.com/nmgwddj"><i class="fa fa-github"></i></a></li></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a target="_blank" rel="noopener" href="https://www.caicai.me"> CaiCai </a><span>&</span><a target="_blank" rel="noopener" href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/archives">归档</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img src="/images/favicon.png"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>CMake 自动安装 git pre-commit hooks</a></h3></div><div class="post-content"><p>在日常开发中，我们经常通过各类 IDE 工具来自动修正代码风格，但由于部分 IDE 工具与 clang-format 配合不是特别完善，导致保存或者按下分号、冒号以后代码自动格式化导致错乱，或者格式化时间过长等问题。这在日常开发中是很难让人接受的。 那么我们有没有办法在开发过程中不去让 clang-format 自动格式化，而是在提交代码时检查一次就够了呢？答案是可以的。Git 天生提供了 pre-commit hooks 能力，允许我们预设一些检查脚本在提交前做一些检查。手动编写脚本是比较麻烦的，而且不同开发者的不同环境适配也是棘手的问题。其实早就有人想到了这些事情，pre-commit 工具就是为这个而生的。</p>
<span id="more"></span>
<h2 id="手动配置-pre-commit"><a href="#手动配置-pre-commit" class="headerlink" title="手动配置 pre-commit"></a>手动配置 pre-commit</h2><p>clang-format、pre-commit 可以通过 pip 来安装，安装完成后在你的项目目录下新建一个配置文件 <code>.pre-commit-config.yaml</code>，内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">repos:</span><br><span class="line">-   repo: https://github.com/pre-commit/pre-commit-hooks</span><br><span class="line">    rev: v4.0.1</span><br><span class="line">    hooks:</span><br><span class="line">    -   id: trailing-whitespace</span><br><span class="line">    -   id: check-added-large-files</span><br><span class="line">    -   id: check-merge-conflict</span><br><span class="line">    -   id: end-of-file-fixer</span><br><span class="line"></span><br><span class="line">-   repo: https://github.com/pocc/pre-commit-hooks</span><br><span class="line">    rev: v1.3.4</span><br><span class="line">    hooks:</span><br><span class="line">    -   id: clang-format</span><br><span class="line">        args: [--style=File]</span><br></pre></td></tr></table></figure>

<p>该配置文件告诉我们要到 `<a target="_blank" rel="noopener" href="https://github.com/pre-commit/pre-commit-hooks/%60">https://github.com/pre-commit/pre-commit-hooks\`</a> 中下载已经开发好的一些检查工具，比如行末尾是否有不必要的空格、是否提交了体积较大的文件等。clang-format 的检查也同样具备。在项目目录下执行如下命令来安装这些钩子到本地：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pre-commit install</span><br></pre></td></tr></table></figure>

<p>pre-commit 会自动读取 <code>.pre-commit-config.yaml</code> 的配置来下载并安装指定钩子，这些钩子最终都会以脚本的方式安装到 .git&#x2F;hooks&#x2F;pre-commit 文件中。此时你再提交代码时响应的钩子会自动运行开始检查你修改过的代码文件，正常情况下返回如下内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Trim Trailing Whitespace.................................................Passed</span><br><span class="line">Check for added large files..............................................Passed</span><br><span class="line">Check for merge conflicts................................................Passed</span><br><span class="line">Fix End of Files.........................................................Passed</span><br><span class="line">clang-format.............................................................Passed</span><br><span class="line">cpplint..................................................................Passed</span><br></pre></td></tr></table></figure>

<p>表示所有检查项检查通过了，但如果有不符合要求的内容，则会出现如下错误：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Trim Trailing Whitespace.................................................Failed</span><br><span class="line">- hook id: trailing-whitespace</span><br><span class="line">- exit code: 1</span><br><span class="line">- files were modified by this hook</span><br><span class="line"></span><br><span class="line">Fixing nim/dllmain.cpp</span><br><span class="line"></span><br><span class="line">Check for added large files..............................................Passed</span><br><span class="line">Check for merge conflicts................................................Passed</span><br><span class="line">Fix End of Files.........................................................Passed</span><br><span class="line">clang-format.............................................................Passed</span><br><span class="line">cpplint..................................................................Passed</span><br></pre></td></tr></table></figure>

<p>一些钩子是可以自动帮你修复代码风格错误的，如果不能自动修复则按提示修复代码内容即可。</p>
<h2 id="通过-CMake-自动配置-pre-commit"><a href="#通过-CMake-自动配置-pre-commit" class="headerlink" title="通过 CMake 自动配置 pre-commit"></a>通过 CMake 自动配置 pre-commit</h2><p>在实际的团队协作中，你很难要求所有人都去手动安装这些钩子来提高代码可读性。特别是新人加入团队，如果这些环境都需要手动配置，那光配置项目的时间可能就要很久。所以我们希望它能自动化掉。我们的项目是通过 CMake 来管理的，所以可以在 CMake 中加入如下代码，让工程在初始化的时候自动去安装 clang-format、pre-commit，并自动执行 <code>pre-commit install</code> 将钩子安装到每个开发人员仓库的 .git&#x2F;hooks 目录下。</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Pre-commit hooks</span></span><br><span class="line"><span class="keyword">IF</span> (<span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="variable">$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span>/.git/hooks/pre-commit)</span><br><span class="line">    <span class="comment"># FIND_PACKAGE(Python3 COMPONENTS Interpreter Development)</span></span><br><span class="line">    <span class="keyword">IF</span> (<span class="keyword">POLICY</span> CMP0094)  <span class="comment"># https://cmake.org/cmake/help/latest/policy/CMP0094.html</span></span><br><span class="line">        <span class="keyword">CMAKE_POLICY</span>(<span class="keyword">SET</span> CMP0094 NEW)  <span class="comment"># FindPython should return the first matching Python</span></span><br><span class="line">    <span class="keyword">ENDIF</span> ()</span><br><span class="line">    <span class="comment"># needed on GitHub Actions CI: actions/setup-python does not touch registry/frameworks on Windows/macOS</span></span><br><span class="line">    <span class="comment"># this mirrors PythonInterp behavior which did not consult registry/frameworks first</span></span><br><span class="line">    <span class="keyword">IF</span> (<span class="keyword">NOT</span> <span class="keyword">DEFINED</span> Python_FIND_REGISTRY)</span><br><span class="line">        <span class="keyword">SET</span>(Python_FIND_REGISTRY <span class="string">&quot;LAST&quot;</span>)</span><br><span class="line">    <span class="keyword">ENDIF</span> ()</span><br><span class="line">    <span class="keyword">IF</span> (<span class="keyword">NOT</span> <span class="keyword">DEFINED</span> Python_FIND_FRAMEWORK)</span><br><span class="line">        <span class="keyword">SET</span>(Python_FIND_FRAMEWORK <span class="string">&quot;LAST&quot;</span>)</span><br><span class="line">    <span class="keyword">ENDIF</span> ()</span><br><span class="line">    <span class="keyword">FIND_PACKAGE</span>(Python REQUIRED COMPONENTS Interpreter)</span><br><span class="line">    <span class="keyword">MESSAGE</span>(STATUS <span class="string">&quot;Python executable: $&#123;Python_EXECUTABLE&#125;&quot;</span>)</span><br><span class="line">    <span class="keyword">EXECUTE_PROCESS</span>(<span class="keyword">COMMAND</span> <span class="variable">$&#123;Python_EXECUTABLE&#125;</span> -m pip <span class="keyword">install</span> clang-format pre-commit)</span><br><span class="line">    <span class="keyword">EXECUTE_PROCESS</span>(<span class="keyword">COMMAND</span> pre-commit <span class="keyword">install</span> WORKING_DIRECTORY <span class="string">&quot;$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;&quot;</span>)</span><br><span class="line"><span class="keyword">ENDIF</span> ()</span><br></pre></td></tr></table></figure>

<p>这样我们就完美的实现了自动安装 pre-commit 钩子的方法。如果您的项目是通过其他工程管理工具来管理的，可以找到一个开发人员必要的入口文件、脚本来添加这些能力。</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2021-12-09</span><i class="fa fa-tag"></i><a class="tag" href="/categories/Tools/" title="Tools">Tools </a><a class="tag" href="/tags/CMake/" title="CMake">CMake </a></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,https://nmgwddj.github.io/2021/12/09/2021/2021-12-09_141701-3088/,Dylan's blog,CMake 自动安装 git pre-commit hooks,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2022/04/09/2022/2022-04-09_164105-3116/" title="使用 Conan、CMake 组织跨平台 Qt 工程">上一篇</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2021/09/02/2021/2021-09-02_192356-3064/" title="主流编辑器、IDE 开启 clang-format 自动格式化能力">下一篇</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>